' Gambas class file

Public nuevaplantilla As Boolean
Public modificado As Boolean = False
Public modo As Integer 'modo añadir=-1, editar=nº de id
Public anadir As Integer = -1
Public reg As New ClassDiplomaTematico
Public actualizarMaq As String = "no"

Public Sub Form_Open()
  'cargar en el combo los ficheros plantillaBase que haya...
  
  If nuevaplantilla = True Then ExpanderMaquetacion.Hidden = False
  '
  
  If modo > -1 Then 
    
    If reg.ImagenFondo <> "" Then 
      PictureBoxFondo.tag = reg.ImagenFondo
      PictureBoxFondo.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenFondo]
    Endif
    
    If reg.ImagenMarco <> "" Then 
      PictureBoxMarco.tag = reg.ImagenMarco
      PictureBoxMarco.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenMarco]
    Endif
    
    If reg.ImagenLogo <> "" Then 
      PictureBoxLogo.tag = reg.ImagenLogo
      PictureBoxLogo.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenLogo]
    Endif
    
    If reg.Foto04 <> "" Then 
      PictureBoxFoto04.tag = reg.Foto04
      PictureBoxFoto04.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.Foto04]
    Endif
    
    If reg.Foto05 <> "" Then 
      PictureBoxFoto05.tag = reg.Foto05
      PictureBoxFoto05.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.Foto05]
    Endif
    
    TextBoxTema.text = reg.Tema
    TextBoxTag.text = reg.Tag
    TextBoxMaquetacion.text = reg.PlantillaBase
    TextBoxNombreDiploma.text = reg.NombrePlantilla
  Else
    TextBoxMaquetacion.text = reg.PlantillaBase
    
  Endif
  
  ModuleIntermedio.CARGALISTA(ListBoxPlantillasBase, ModulePrincipal.RutaPrograma & "PlantillasBases", "*.svg")
  
  Me.center
  ToolButtonPrevisualizar_Click()
  
End

Public Sub ToolButtonCancelarDiploma2_Click()
  'borra la previsualizacion, por si ha cambiado algo, repitera la creacion de la previsualizacion
  
  borradoMiniatura()
  
  Me.Close
  
End

Public Sub ToolButtonAceptarDiploma_Click()
  
  borradoMiniatura()
  reg.NombrePlantilla = TextBoxNombreDiploma.text
  reg.PlantillaBase = TextBoxMaquetacion.text
  reg.Tag = TextBoxTag.Text
  reg.Tema = TextBoxTema.Text
  reg.ImagenFondo = PictureBoxFondo.Tag
  reg.ImagenLogo = PictureBoxLogo.Tag
  reg.ImagenMarco = PictureBoxMarco.Tag
  reg.Foto04 = PictureBoxFoto04.Tag
  reg.Foto05 = PictureBoxFoto05.Tag
  
  If modo = anadir Then
    ModuleGestionDiploma.anadirRegistro(reg)
    
  Else
    'editando...
    ModuleGestionDiploma.EditarRegistro(reg, modo)
  Endif
  Me.Close
  
End

Public Sub PictureBoxFondo_MouseDown()
  
  reg.ImagenFondo = asignaImagen(PictureBoxFondo)
  PictureBoxFondo.tag = reg.ImagenFondo
  
End

Private Sub asignaImagen(PictureBoxElegido As Picturebox) As String
  
  Dim nombrecopia As String
  Dim extension As String
  Dim comparacion As String 'añadido para comprobar si existe un fichero con el mismo nombre y es igual
  Dim copiar As String
  Dim comando As String
  Dim nombresimple As String
  
  Dialog.Title = "Elija el archivo gráfico"
  
  Dialog.Filter = ["*.*", "todos", "*.png", "png", "*.jpg", "jpg"]
  If Not Dialog.OpenFile() Then 
    
    PictureBoxElegido.Picture = Picture[Dialog.Path]
    PictureBoxElegido.tag = Dialog.Path
    copiar = "si"
    
    nombresimple = ModuleUtilidadesDisco.VerificarNombreEtiqueta(Replace(ModuleUtilidadesDisco.extraedesdebarra(PictureBoxElegido.tag), " ", "_"), ["FOTO", "PLANTILLA", "CAMPO"], ["Imagen", "PLA_TILLA", "CA_PO"])
    nombrecopia = ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & nombresimple
    
    While (Exist(nombrecopia))
      'si existe fichero con el mismo nombre, 1º comprobar si es igual...
      comando = "cmp " & nombrecopia & " " & PictureBoxElegido.tag
      Shell comando To comparacion
      If comparacion = "" Then 
        'son iguales-> no hace falta cambiar de nombre ya que lo tengo...
        'no hago la copia
        copiar = "no"
        
        Break
      Endif
      
      'para que no machaque nombres de fichros...
      extension = ModuleUtilidadesDisco.extraeExtension(nombrecopia)
      If extension <> "" Then 
        nombrecopia = Mid$(nombrecopia, 1, Len(nombrecopia) - Len(extension) - 1) & "c" & "." & extension
        copiar = "si"
      Else
        nombrecopia = Mid$(nombrecopia, 1, Len(nombrecopia) - Len(extension)) & "c" 
        copiar = "si"
      Endif
      
    Wend
    
    If copiar = "si" Then 
      
      Exec ["cp", PictureBoxElegido.tag, nombrecopia] Wait
    Endif
  Endif
  
  Return ModuleUtilidadesDisco.extraedesdebarra(nombrecopia)
  
End

Public Sub PictureBoxMarco_MouseDown()
  
  reg.ImagenMarco = asignaImagen(PictureBoxMarco)
  PictureBoxMarco.tag = reg.ImagenMarco
  
End

Public Sub PictureBoxLogo_MouseDown()
  
  reg.ImagenLogo = asignaImagen(PictureBoxlogo)
  PictureBoxlogo.tag = reg.ImagenLogo
  
End

Public Sub PictureBoxFoto04_MouseDown()
  
  reg.Foto04 = asignaImagen(PictureBoxFoto04)
  PictureBoxfoto04.tag = reg.Foto04
  
End

Public Sub PictureBoxFoto05_MouseDown()
  
  reg.Foto05 = asignaImagen(PictureBoxFoto05)
  PictureBoxfoto05.tag = reg.Foto05
  
End

Public Sub ToolButton1_Click()
  
End

Public Sub ToolButtonPrevisualizar_Click()
  
  If reg.PlantillaBase <> "" Then 
    'cojo los datos actuales y hago la presentacion de los mismos...
    reg.NombrePlantilla = TextBoxNombreDiploma.text
    reg.PlantillaBase = TextBoxMaquetacion.text
    reg.Tag = TextBoxTag.Text
    reg.Tema = TextBoxTema.Text
    reg.ImagenFondo = PictureBoxFondo.Tag
    reg.ImagenLogo = PictureBoxLogo.Tag
    reg.ImagenMarco = PictureBoxMarco.Tag
    reg.Foto04 = PictureBoxFoto04.Tag
    reg.Foto05 = PictureBoxFoto05.Tag
    ModuleImprimir.PrevisualizarPlantillaTematicaRegistro(reg, DrawingAreaPrevisualizarMini)
  Else
    Message.Error(("Deberá especificar una maquetación para el Diploma"))
  Endif
  
End

Public Sub ListBoxPlantillasBase_Click()
  
  If actualizarMaq = "no" Then 
    actualizarMaq = "Si"
  Else
    
    TextBoxMaquetacion.text = ListBoxPlantillasBase.List[ListBoxPlantillasBase.index]
    reg.PlantillaBase = TextBoxMaquetacion.text
  Endif
  
End

Public Sub ToolButtonEditaPlantilla_Click()
  
  '  Dim tex As String
  Dim comando As String
  
  comando = "inkscape " & ModulePrincipal.RutaPrograma & "PlantillasBases/" & ListBoxPlantillasBase.text
  Shell comando 
  
End

Public Sub ToolButtonAnadirPlantilla_Click()
  
  ModuleIntermedio.anadirPlantilla()
  ModuleIntermedio.CARGALISTA(ListBoxPlantillasBase, ModulePrincipal.RutaPrograma & "PlantillasBases", "*.svg")
  
End

Public Sub ToolButtonCrearPlantilla_Click()
  '  Dim tex As String
  
  Dim salir As Boolean = True
  Dim comando As String
  Dim nombrePlantillaNueva As String
  'repetir hasta conseguir un nombre que no sea igual...
  While (salir = True)
    
    nombrePlantillaNueva = Replace(InputBox("Introduce un nombre de la nueva plantilla:", "Crear una plantilla", "personalizada.svg"), " ", "_")
    If nombrePlantillaNueva = "" Then Return 
    If Lower(nombrePlantillaNueva) Not Ends ".svg" Then nombrePlantillaNueva = Lower(nombrePlantillaNueva) & ".svg"
    If Exist(ModulePrincipal.RutaPrograma & "PlantillasBases/" & nombrePlantillaNueva) Then 
      Message.Error(("Existe una plantilla con el mismo nombre"))
      
    Else
      salir = False
    Endif
  Wend
  
  Try Copy ModulePrincipal.RutaPrograma & "PlantillasBases/plantilla0.svg" To ModulePrincipal.RutaPrograma & "PlantillasBases/" & nombrePlantillaNueva
  If Not Error Then 
    comando = "inkscape " & ModulePrincipal.RutaPrograma & "PlantillasBases/" & nombrePlantillaNueva
    Shell comando Wait
    ModuleIntermedio.CARGALISTA(ListBoxPlantillasBase, ModulePrincipal.RutaPrograma & "PlantillasBases", "*.svg")
  Else
    
    Message.Info(("Error al copiar palntilla"))
  Endif
  
End

Public Sub ToolButtonBorrarPlantilla_Click()
  
  ModuleIntermedio.borradoElementoLista(ListBoxPlantillasBase)
  
  If ListBoxPlantillasBase.index >= 0 Then 
    ListBoxPlantillasBase.index = 0 'elijo el primer elemento
    
  Endif
  
End

Public Sub ToolButtonAceptarDiploma2_Click()
  'borra la previsualizacion, por si ha cambiado algo, repitera la creacion de la previsualizacion
  
  'Guardamo como un registro nuevo...
  modo = anadir
  ToolButtonAceptarDiploma_Click()
  
End

Public Sub botontransparente_Click()
  
  Dim numero As Integer
  Dim boton As Integer
  
  numero = Val(Last.tag)
  
  Select numero
    Case 1
      reg.ImagenFondo = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.ImagenFondo)
      PictureBoxFondo.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenFondo]
      PictureBoxFondo.tag = reg.ImagenFondo 
    Case 2
      reg.ImagenMarco = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.ImagenMarco)
      PictureBoxMarco.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenMarco]
      PictureBoxMarco.tag = reg.ImagenMarco
    Case 3
      reg.ImagenLogo = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.ImagenLogo)
      PictureBoxLogo.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.ImagenLogo]
      PictureBoxlogo.tag = reg.ImagenLogo
    Case 4
      reg.Foto04 = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.Foto04)
      PictureBoxFoto04.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.Foto04]
      PictureBoxfoto04.tag = reg.Foto04
    Case 5
      reg.Foto05 = ModuleHacerTransparente.convertirTransparente(ModulePrincipal.RutaPrograma & "temporales/FotosPlantillasTematica/" & reg.Foto05)
      PictureBoxFoto05.Picture = Picture[ModulePrincipal.rutaprograma & "temporales/FotosPlantillasTematica/" & reg.Foto05]
      PictureBoxfoto05.tag = reg.Foto05
  End Select
  
End

Public Sub borradoMiniatura()
  
  Dim rutamini As String
  
  'rutamini = String.Mid(ModulePrincipal.rutaprograma & "temporales/PlantillasBases/" & reg.PlantillaBase & Replace$(reg.tema, " ", "_"), 1, String.Len(ModulePrincipal.rutaprograma & "PlantillasBases/" & reg.PlantillaBase & Replace$(reg.tema, " ", "_"))) & "mini.png"
  
  rutamini = ModulePrincipal.rutaprograma & "temporales/PlantillasBases/" & reg.PlantillaBase & Replace$(reg.NombrePlantilla, " ", "_") & "mini.png"
  
  Kill rutamini 
  
End
